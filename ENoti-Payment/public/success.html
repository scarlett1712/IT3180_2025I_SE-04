<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Thanh to√°n th√†nh c√¥ng</title>

  <style>
    body {
        margin: 0;
        padding: 0;
        font-family: Arial, sans-serif;
        background: #f0f7ff;
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100vh;
        color: #333;
    }

    .container {
        text-align: center;
        background: white;
        padding: 30px 40px;
        border-radius: 15px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        width: 90%;
        max-width: 420px;
        animation: fadeIn 0.6s ease-in-out;
    }

    .icon {
        font-size: 70px;
        color: #2ecc71;
        margin-bottom: 10px;
    }

    h1 {
        margin: 10px 0;
        font-size: 26px;
        color: #2ecc71;
    }

    p {
        font-size: 16px;
        margin-bottom: 20px;
    }

    .btn {
        display: inline-block;
        padding: 12px 22px;
        background: #3498db;
        color: white;
        text-decoration: none;
        border-radius: 10px;
        font-size: 15px;
        transition: 0.25s;
    }

    .btn:hover {
        background: #2980b9;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(15px); }
        to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>

<body>
<div class="container">
  <div class="icon">‚úî</div>
  <h1>Thanh to√°n th√†nh c√¥ng!</h1>
  <p id="statusMessage">C·∫£m ∆°n b·∫°n ƒë√£ ho√†n t·∫•t giao d·ªãch. ƒêang x·ª≠ l√Ω h√≥a ƒë∆°n...</p>

  <a class="btn" href="enoti://payment/success">Quay v·ªÅ ·ª©ng d·ª•ng</a>
</div>

<!-- üî• S·ª¨A TO√ÄN B·ªò SCRIPT ·ªû ƒê√ÇY -->
<script>
  document.addEventListener("DOMContentLoaded", () => {
    handleInvoiceAndRedirect();
  });

  async function handleInvoiceAndRedirect() {
    const statusMessage = document.getElementById("statusMessage");

    try {
      const params = new URLSearchParams(window.location.search);

      // 1. L·∫•y d·ªØ li·ªáu t·ª´ URL (TH√äM user_id)
      const finance_id = params.get("finance_id");
      const user_id = params.get("user_id"); // üî• QUAN TR·ªåNG: L·∫•y user_id
      const amount = params.get("amount");
      const description = params.get("description");
      const ordercode = params.get("ordercode") || params.get("orderCode");
      const currency = params.get("currency") || "VND";

      // 2. Validate d·ªØ li·ªáu
      if (!finance_id || !user_id || !amount || !ordercode) {
        console.error("Thi·∫øu d·ªØ li·ªáu:", { finance_id, user_id, amount, ordercode });
        statusMessage.innerText = "L·ªói: Thi·∫øu th√¥ng tin giao d·ªãch (User ID/Order Code).";
        redirectToApp(3000);
        return;
      }

      console.log("ƒêang x·ª≠ l√Ω h√≥a ƒë∆°n...");

      // 3. G·ªçi API /store
      const response = await fetch("https://nmcnpm-se-04.onrender.com/api/invoice/store", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          finance_id: parseInt(finance_id),
          user_id: parseInt(user_id), // üî• QUAN TR·ªåNG: G·ª≠i user_id l√™n
          amount: parseInt(amount),
          description: description,
          ordercode: ordercode,
          currency: currency
        })
      });

      const resData = await response.json();

      if (response.ok && resData.success) {
        console.log("L∆∞u h√≥a ƒë∆°n th√†nh c√¥ng!");
        statusMessage.innerText = "Giao d·ªãch th√†nh c√¥ng! ƒêang quay v·ªÅ ·ª©ng d·ª•ng...";
      } else {
        console.error("L·ªói API:", resData);
        // N·∫øu h√≥a ƒë∆°n ƒë√£ t·ªìn t·∫°i th√¨ v·∫´n coi l√† th√†nh c√¥ng ƒë·ªÉ user kh√¥ng lo l·∫Øng
        if(resData.message && resData.message.includes("ƒë√£ t·ªìn t·∫°i")) {
             statusMessage.innerText = "Giao d·ªãch ƒë√£ ƒë∆∞·ª£c ghi nh·∫≠n tr∆∞·ªõc ƒë√≥.";
        } else {
             statusMessage.innerText = "C√≥ l·ªói khi l∆∞u h√≥a ƒë∆°n: " + (resData.error || "Kh√¥ng r√µ");
        }
      }

    } catch (err) {
      console.error("L·ªói m·∫°ng:", err);
      statusMessage.innerText = "L·ªói k·∫øt n·ªëi ƒë·∫øn m√°y ch·ªß.";
    }

    // 4. Redirect v·ªÅ app
    redirectToApp(2000);
  }

  function redirectToApp(delay) {
    setTimeout(() => {
      // Deep link quay v·ªÅ Android
      window.location.href = "enoti://payment/success";
    }, delay);
  }
</script>

</body>
</html>