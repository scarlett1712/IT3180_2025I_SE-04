<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Thanh to√°n th√†nh c√¥ng</title>

  <style>
    body {
        margin: 0;
        padding: 0;
        font-family: Arial, sans-serif;
        background: #f0f7ff;
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100vh;
        color: #333;
    }

    .container {
        text-align: center;
        background: white;
        padding: 30px 40px;
        border-radius: 15px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        width: 90%;
        max-width: 420px;
        animation: fadeIn 0.6s ease-in-out;
    }

    .icon {
        font-size: 70px;
        color: #2ecc71;
        margin-bottom: 10px;
    }

    h1 {
        margin: 10px 0;
        font-size: 26px;
        color: #2ecc71;
    }

    p {
        font-size: 16px;
        margin-bottom: 20px;
    }

    .btn {
        display: inline-block;
        padding: 12px 22px;
        background: #3498db;
        color: white;
        text-decoration: none;
        border-radius: 10px;
        font-size: 15px;
        transition: 0.25s;
    }

    .btn:hover {
        background: #2980b9;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(15px); }
        to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>

<body>
<div class="container">
  <div class="icon">‚úî</div>
  <h1>Thanh to√°n th√†nh c√¥ng!</h1>
  <p id="statusMessage">C·∫£m ∆°n b·∫°n ƒë√£ ho√†n t·∫•t giao d·ªãch. ƒêang x·ª≠ l√Ω h√≥a ƒë∆°n...</p>

  <a class="btn" href="enoti://payment/success">Quay v·ªÅ ·ª©ng d·ª•ng</a>
</div>

<!-- üî• S·ª¨A TO√ÄN B·ªò SCRIPT ·ªû ƒê√ÇY -->
<script>
  // Ch·∫°y ngay khi DOM ƒë∆∞·ª£c load
  document.addEventListener("DOMContentLoaded", () => {
    // G·ªçi h√†m x·ª≠ l√Ω b·∫•t ƒë·ªìng b·ªô
    handleInvoiceAndRedirect();
  });

  async function handleInvoiceAndRedirect() {
    const statusMessage = document.getElementById("statusMessage");

    try {
      const params = new URLSearchParams(window.location.search);

      // 1. L·∫•y T·∫§T C·∫¢ d·ªØ li·ªáu t·ª´ URL
      // (PayOS c√≥ th·ªÉ tr·∫£ v·ªÅ orderCode, nh∆∞ng ch√∫ng ta ∆∞u ti√™n
      // ordercode (ch·ªØ th∆∞·ªùng) m√† ch√∫ng ta t·ª± th√™m v√†o)
      const finance_id = params.get("finance_id");
      const amount = params.get("amount");
      const description = params.get("description");
      const ordercode = params.get("ordercode") || params.get("orderCode"); // L·∫•y 1 trong 2
      const currency = params.get("currency") || "VND"; // M·∫∑c ƒë·ªãnh VND

      // 2. Ki·ªÉm tra d·ªØ li·ªáu
      if (!finance_id || !amount || !description || !ordercode) {
        console.error("D·ªØ li·ªáu URL b·ªã thi·∫øu:", { finance_id, amount, description, ordercode });
        statusMessage.innerText = "L·ªói: D·ªØ li·ªáu thanh to√°n b·ªã thi·∫øu.";
        // V·∫´n redirect v·ªÅ app
        redirectToApp(3000);
        return;
      }

      console.log("ƒêang g·ª≠i ƒëi:", { finance_id, amount, description, ordercode, currency });

      // 3. G·ªçi API /store v√† CH·ªú (await)
      const response = await fetch("https://nmcnpm-se-04.onrender.com/api/invoice/store", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          finance_id: parseInt(finance_id), // ƒê·∫£m b·∫£o l√† s·ªë
          amount: parseInt(amount),         // ƒê·∫£m b·∫£o l√† s·ªë
          description: description,
          ordercode: ordercode,
          currency: currency
        })
      });

      if (response.ok) {
        console.log("T·∫°o invoice th√†nh c√¥ng!");
        statusMessage.innerText = "ƒê√£ x·ª≠ l√Ω h√≥a ƒë∆°n. ƒêang quay v·ªÅ ·ª©ng d·ª•ng...";
      } else {
        const errorData = await response.json();
        console.error("L·ªói t·∫°o invoice:", errorData);
        statusMessage.innerText = "L·ªói khi l∆∞u h√≥a ƒë∆°n.";
      }

    } catch (err) {
      console.error("L·ªói fetch:", err);
      statusMessage.innerText = "L·ªói m·∫°ng khi x·ª≠ l√Ω h√≥a ƒë∆°n.";
    }

    // 4. Redirect v·ªÅ app sau khi ƒë√£ x·ª≠ l√Ω xong
    redirectToApp(2000);
  }

  function redirectToApp(delay) {
    setTimeout(() => {
      window.location.href = "enoti://payment/success";
    }, delay);
  }
</script>

</body>
</html>