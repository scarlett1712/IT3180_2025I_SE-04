<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Thanh toán thành công</title>

  <style>
    body {
        margin: 0;
        padding: 0;
        font-family: Arial, sans-serif;
        background: #f0f7ff;
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100vh;
        color: #333;
    }

    .container {
        text-align: center;
        background: white;
        padding: 30px 40px;
        border-radius: 15px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        width: 90%;
        max-width: 420px;
        animation: fadeIn 0.6s ease-in-out;
    }

    .icon {
        font-size: 70px;
        color: #2ecc71;
        margin-bottom: 10px;
    }

    h1 {
        margin: 10px 0;
        font-size: 26px;
        color: #2ecc71;
    }

    p {
        font-size: 16px;
        margin-bottom: 20px;
    }

    .btn {
        display: inline-block;
        padding: 12px 22px;
        background: #3498db;
        color: white;
        text-decoration: none;
        border-radius: 10px;
        font-size: 15px;
        transition: 0.25s;
    }

    .btn:hover {
        background: #2980b9;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(15px); }
        to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>

<script>
  document.addEventListener("DOMContentLoaded", async () => {
    const params = new URLSearchParams(window.location.search);

    // Lấy tất cả tham số từ URL
    const ordercode = params.get("orderCode");
    const amount = params.get("amount");
    const description = params.get("description");
    const currency = params.get("currency");

    // ✅ FIX 1: Lấy finance_id từ URL, KHÔNG dùng localStorage
    const finance_id = params.get("finance_id");

    const statusMessage = document.querySelector("p");

    if (ordercode && finance_id) {
      try {
        statusMessage.innerText = "Đang xử lý hóa đơn...";

        // ✅ FIX 2: Dùng await để đợi server xử lý xong
        const response = await fetch("https://nmcnpm-se-04.onrender.com/api/invoice/store", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            finance_id,
            amount,
            description,
            ordercode,
            currency
          })
        });

        if (response.ok) {
             console.log("Invoice created successfully");
        } else {
             console.error("Failed to create invoice", await response.text());
        }

      } catch (error) {
        console.error("Network error:", error);
      }
    }

    // Sau khi xử lý xong (hoặc nếu lỗi) thì mới redirect
    statusMessage.innerText = "Đang quay về ứng dụng...";
    setTimeout(() => {
      // Truyền thêm cờ để App biết đã xử lý xong
      window.location.href = "enoti://payment/success";
    }, 1500);
  });
</script>

<body>
<div class="container">
  <div class="icon">✔</div>
  <h1>Thanh toán thành công!</h1>
  <p>Cảm ơn bạn đã hoàn tất giao dịch. Bạn có thể quay lại ứng dụng để tiếp tục sử dụng.</p>

  <a class="btn" href="enoti://payment/success">Quay về ứng dụng</a>
</div>
</body>
</html>
